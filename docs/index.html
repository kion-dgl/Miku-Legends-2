<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <title>Miku Legends 2</title>
        <script src="https://cdn.jsdelivr.net/npm/tsparticles@2/tsparticles.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/spark-md5/3.0.2/spark-md5.min.js"></script>

        <link
            href="https://cdn.jsdelivr.net/npm/daisyui@4.12.13/dist/full.min.css"
            rel="stylesheet"
            type="text/css"
        />
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="flex flex-col h-screen">
        <!-- START NAVBAR -->
        <nav class="navbar bg-base-100">
            <div class="flex-1">
                <a class="btn btn-ghost text-xl">Miku Legends 2</a>
            </div>
            <div class="flex-none">
                <div class="dropdown dropdown-end">
                    <div
                        tabindex="0"
                        role="button"
                        class="btn btn-ghost btn-circle"
                    >
                        <div class="indicator">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"
                                />
                            </svg>
                            <span class="badge badge-sm indicator-item">8</span>
                        </div>
                    </div>
                    <div
                        tabindex="0"
                        class="card card-compact dropdown-content bg-base-100 z-[1] mt-3 w-52 shadow"
                    >
                        <div class="card-body">
                            <span class="text-lg font-bold">8 Items</span>
                            <span class="text-info">Subtotal: $999</span>
                            <div class="card-actions">
                                <button class="btn btn-primary btn-block">
                                    View cart
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="dropdown dropdown-end">
                    <div
                        tabindex="0"
                        role="button"
                        class="btn btn-ghost btn-circle avatar"
                    >
                        <div class="w-10 rounded-full">
                            <img
                                alt="Tailwind CSS Navbar component"
                                src="https://img.daisyui.com/images/stock/photo-1534528741775-53994a69daeb.webp"
                            />
                        </div>
                    </div>
                    <ul
                        tabindex="0"
                        class="menu menu-sm dropdown-content bg-base-100 rounded-box z-[1] mt-3 w-52 p-2 shadow"
                    >
                        <li>
                            <a class="justify-between">
                                Profile
                                <span class="badge">New</span>
                            </a>
                        </li>
                        <li><a>Settings</a></li>
                        <li><a>Logout</a></li>
                    </ul>
                </div>
            </div>
        </nav>
        <!-- END NAVBAR -->

        <!-- START HERO -->
        <div class="hero bg-base-200 flex-grow" id="particles-js">
            <div class="hero-content text-center relative z-10">
                <div class="max-w-md">
                    <h1 class="text-5xl font-bold">Hello there</h1>
                    <p class="py-6">
                        <label
                            >Original File:
                            <input type="file" id="input" /></label
                        ><br />
                        <button id="applyPatch">Apply Patch</button>
                        <a id="downloadLink" style="display: none"
                            >Download Patched File</a
                        >
                    </p>
                    <button class="btn btn-primary">Get Started</button>
                </div>
            </div>
        </div>
        <!-- END HERO -->

        <script type="module">
            // Initialize the particles
            tsParticles.load("particles-js", {
                particles: {
                    number: {
                        value: 160,
                        density: { enable: true, value_area: 800 },
                    },
                    color: { value: "#ffffff" },
                    shape: {
                        type: "circle",
                        stroke: { width: 0, color: "#000000" },
                        polygon: { nb_sides: 5 },
                        image: {
                            src: "img/github.svg",
                            width: 100,
                            height: 100,
                        },
                    },
                    opacity: {
                        value: 1,
                        random: true,
                        anim: {
                            enable: true,
                            speed: 1,
                            opacity_min: 0,
                            sync: false,
                        },
                    },
                    size: {
                        value: 3,
                        random: true,
                        anim: {
                            enable: false,
                            speed: 4,
                            size_min: 0.3,
                            sync: false,
                        },
                    },
                    line_linked: {
                        enable: false,
                        distance: 150,
                        color: "#ffffff",
                        opacity: 0.4,
                        width: 1,
                    },
                    move: {
                        enable: true,
                        speed: 1,
                        direction: "none",
                        random: true,
                        straight: false,
                        out_mode: "out",
                        bounce: false,
                        attract: { enable: false, rotateX: 600, rotateY: 600 },
                    },
                },
                interactivity: {
                    detect_on: "canvas",
                    events: {
                        onhover: { enable: true, mode: "bubble" },
                        onclick: { enable: false, mode: "repulse" },
                        resize: true,
                    },
                    modes: {
                        grab: { distance: 400, line_linked: { opacity: 1 } },
                        bubble: {
                            distance: 250,
                            size: 0,
                            duration: 2,
                            opacity: 0,
                            speed: 3,
                        },
                        repulse: { distance: 400, duration: 0.4 },
                        push: { particles_nb: 4 },
                        remove: { particles_nb: 2 },
                    },
                },
                retina_detect: true,
            });
        </script>
        <script type="module">
            function calculateMD5(file) {
                return new Promise((resolve, reject) => {
                    const spark = new SparkMD5.ArrayBuffer();
                    const reader = new FileReader();
                    let offset = 0;
                    const CHUNK_SIZE = 64 * 1024;

                    reader.onload = (e) => {
                        spark.append(e.target.result);
                        offset += CHUNK_SIZE;

                        if (offset < file.size) {
                            readNextChunk();
                        } else {
                            resolve(spark.end());
                        }
                    };

                    reader.onerror = (err) => reject(err);

                    function readNextChunk() {
                        const slice = file.slice(offset, offset + CHUNK_SIZE);
                        reader.readAsArrayBuffer(slice);
                    }

                    readNextChunk();
                });
            }

            const input = document.getElementById("input");
            input.addEventListener("change", async (evt) => {
                event.preventDefault();
                if (!evt.target.files) {
                    return;
                }

                console.log("change!!");

                const file = evt.target.files[0];

                const CHECK_SUM = false;
                if (CHECK_SUM) {
                    const MML2_MD5 = "e7039345d54c1bfc3775a468d4125d48";
                    const md5 = await calculateMD5(file);

                    if (md5 !== MML2_MD5) {
                        return confirm(
                            "md5 does not match, would you like to proceed?",
                        );
                    }
                }

                const req = await fetch("./patch.json");
                const patch = await req.json();
                const buffer = await file.arrayBuffer();
                const data = new Uint8Array(buffer);
                console.log(buffer);
                console.log(data);

                console.log("apply patch!!");
                patch.forEach((patch) => {
                    const { offset, bytes } = patch;
                    const patchBytes = Uint8Array.from(atob(bytes), (c) =>
                        c.charCodeAt(0),
                    );

                    // Apply the patch bytes at the given offset
                    for (let i = 0; i < patchBytes.length; i++) {
                        data[offset + i] = patchBytes[i];
                    }
                });

                console.log("DOWNLAOD Patch");
                const blob = new Blob([data.buffer], {
                    type: "application/octet-stream",
                });
                const url = URL.createObjectURL(blob);

                const downloadLink = document.getElementById("downloadLink");
                downloadLink.href = url;
                downloadLink.download = "MIKU2-patched.bin";
                downloadLink.style.display = "block";
                downloadLink.textContent = "Download Patched File";
            });
        </script>
    </body>
</html>
